rules_version = '2';

// Craft rules based on data in your Firestore database
// allow write: if firestore.get(
//    /databases/(default)/documents/users/$(request.auth.uid)).data.isAdmin == true;
service firebase.storage {
  match /b/{bucket}/o {
    // 사용자별 업로드 폴더 구조
    match /users/{userId}/uploads/{allPaths=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // 사용자별 비디오 생성 폴더 (자동 업로드용)
    match /users/{userId}/uploads/videos/generate/{allPaths=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // 사용자별 생성된 이미지 폴더
    match /users/{userId}/generatedImg/{allPaths=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // 사용자별 비디오 폴더
    match /users/{userId}/videos/{allPaths=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // 사용자별 Generated Video 폴더
    match /users/{userId}/newsVideos/{allPaths=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // 사용자별 newsVideo 폴더 (공개 읽기 접근 허용)
    match /users/{userId}/newsVideo/{allPaths=**} {
      allow read: if true; // 공개 읽기 접근 허용
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // 사용자별 아바타 폴더
    match /users/{userId}/avatars/{allPaths=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // 기존 호환성을 위한 규칙들 (점진적 마이그레이션)
    match /uploads/{userId}/{allPaths=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    match /videos/{videoId} {
      allow read, write: if request.auth != null;
    }
    
    match /images/categories/{userId}_{allPaths=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // 공개 읽기 접근 (생성된 이미지용)
    match /genImage/{allPaths=**} {
      allow read: if true;
      allow write: if request.auth != null;
    }
    
    // 연결된 영상 비디오 폴더 - 공개 읽기 접근 허용
    match /users/{userId}/uploads/videos/connected-videos/{allPaths=**} {
      allow read: if true; // 공개 읽기 접근 허용
      allow write: if request.auth != null && request.auth.uid == userId;
    }
  }
} 